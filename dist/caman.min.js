!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.Caman=e()}(this,function(){"use strict";var u="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},l=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},i=function(){function r(t,e){for(var i=0;i<e.length;i++){var r=e[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(t,e,i){return e&&r(t.prototype,e),i&&r(t,i),t}}(),g=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e},r=["extended","included"],e=function(){function t(){l(this,t)}return i(t,null,[{key:"extends",value:function(t){for(var e in t)-1===r.indexOf&&(this[e]=t[e]);return t.extended&&t.extended.apply(this),this}},{key:"includes",value:function(t){for(var e in t)-1===r.indexOf&&(this.prototype[e]=t[e]);return t.included&&t.included.apply(this),this}},{key:"delegate",value:function(){for(var t=arguments.length,e=Array(t),i=0;i<t;i++)e[i]=arguments[i];var r=e.pop();for(var n in e){var s=e[n];this.prototype[s]=r.prototype[s]}}},{key:"aliasFunction",value:function(t,r){var n=this;this.prototype[t]=function(){for(var t=arguments.length,e=Array(t),i=0;i<t;i++)e[i]=arguments[i];n.prototype[r].apply(n,e)}}},{key:"aliasProperty",value:function(t,e){Object.defineProperty(this.prototype,t,{get:function(){return this[e]},set:function(t){this[e]=t}})}},{key:"included",value:function(t){t.call(this,this.prototype)}}]),t}(),n=function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:document;return"object"===(void 0===t?"undefined":u(t))||"undefined"!=typeof exports?t:e.querySelector(t)};function d(){}var y=function(){function t(){l(this,t)}return i(t,null,[{key:"uniqid",value:function(){var t=0;return{get:function(){return t++}}}},{key:"extend",value:function(t){for(var e=t,i=arguments.length,r=Array(1<i?i-1:0),n=1;n<i;n++)r[n-1]=arguments[n];for(var s in r){var a=r[s];for(var o in a)a.hasOwnProperty(o)&&(e[o]=a[o])}return e}},{key:"clampRGB",value:function(t){return t<0?0:255<t?255:t}},{key:"copyAttributes",value:function(t,e){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};for(var r in t.attributes){var n=t.attributes[r];i.except&&-1!==i.except.indexOf(n.nodeName)||e.setAttribute(n.nodeName,n.nodeValue)}}},{key:"dataArray",value:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0;return Uint8Array?new Uint8Array(t):new Array(t)}}]),t}(),v=function(){function t(){l(this,t)}return i(t,null,[{key:"has",value:function(t){return!!this.items[t]}},{key:"get",value:function(t){return this.items[t]}},{key:"put",value:function(t,e){this.items[t]=e}},{key:"execute",value:function(t,e){var i=this;return setTimeout(function(){e.call(i.get(t),i.get(t))},0),this.get(t)}},{key:"flush",value:function(){var t=0<arguments.length&&void 0!==arguments[0]&&arguments[0];t?delete this.items[t]:this.items={}}}]),t}();Object.defineProperty(v,"items",{enumerable:!0,writable:!0,value:{}});var f=function(){function e(t){l(this,e),this.c=t}return i(e,[{key:"calculateLevels",value:function(){for(var t={r:{},g:{},b:{}},e=0;e<=255;e++)t.r[e]=0,t.g[e]=0,t.b[e]=0;for(var i=0,r=this.c.pixelData.length;i<r;i+=4)t.r[this.c.pixelData[i]]++,t.g[this.c.pixelData[i+1]]++,t.b[this.c.pixelData[i+2]]++;for(var n=this.c.pixelData.length/4,s=0;s<=255;s++)t.r[s]/=n,t.g[s]/=n,t.b[s]/=n;return t}}]),e}(),s=function(){function t(){l(this,t)}return i(t,null,[{key:"trigger",value:function(t,e){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;if(this.events[e]&&this.events[e].length)for(var r in this.events[e]){var n=this.events[e][r];null!==n.target&&t.id!==n.target.id||n.fn.call(t,i)}}},{key:"listen",value:function(t,e,i){if("string"==typeof t){var r=t,n=e;t=null,e=r,i=n}return-1!==this.types.indexOf(e)&&(this.events[e]||(this.events[e]=[]),this.events[e].push({target:t,fn:i}),!0)}}]),t}();Object.defineProperty(s,"events",{enumerable:!0,writable:!0,value:{}}),Object.defineProperty(s,"types",{enumerable:!0,writable:!0,value:["processStart","processComplete","renderStart","renderFinished","blockStarted","blockFinished"]});var a=function(){function t(){l(this,t)}return i(t,null,[{key:"register",value:function(t,e){c.prototype[t]=e}}]),t}();Object.defineProperty(a,"Type",{enumerable:!0,writable:!0,value:{Single:1,Kernel:2,LayerDequeue:3,LayerFinished:4,LoadOverlay:5,Plugin:6}});var b=new function t(){var e=this;l(this,t);var i=["log","info","warn","error"],r=function(t){var r=i[t];e[r]=function(){for(var t=arguments.length,e=Array(t),i=0;i<t;i++)e[i]=arguments[i];if(c.DEBUG)try{console[r].apply(console,e)}catch(t){console[r](e)}}};for(var n in i)r(n);this.debug=this.log},t=function(){function t(){l(this,t)}return i(t,null,[{key:"register",value:function(t,e){this.plugins[t]=e}},{key:"execute",value:function(t,e,i){this.plugins[e].apply(t,i)}}]),t}();Object.defineProperty(t,"plugins",{enumerable:!0,writable:!0,value:{}});var m=function(){function s(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:255,n=4<arguments.length&&void 0!==arguments[4]?arguments[4]:null;l(this,s),this.loc=0,this.r=t,this.g=e,this.b=i,this.a=r,this.c=n}return i(s,null,[{key:"coordinatesToLocation",value:function(t,e,i){return 4*(e*i+t)}},{key:"locationToCoordinates",value:function(t,e){return{x:t%(4*e)/4,y:Math.floor(t/(4*e))}}}]),i(s,[{key:"setContext",value:function(t){this.c=t}},{key:"locationXY",value:function(){if(!this.c)throw new Error("Requires a CamanJS context");var t=this.c.dimensions.height-Math.floor(this.loc/(4*this.c.dimensions.width));return{x:this.loc%(4*this.c.dimensions.width)/4,y:t}}},{key:"pixelAtLocation",value:function(t){if(!this.c)throw new Error("Requires a CamanJS context");return new s(this.c.pixelData[t],this.c.pixelData[t+1],this.c.pixelData[t+2],this.c.pixelData[t+3],this.c)}},{key:"getPixelRelative",value:function(t,e){if(!this.c)throw new Error("Requires a CamanJS context");var i=this.loc+4*this.c.dimensions.width*(-1*e)+4*t;return i>this.c.pixelData.length||i<0?new s(0,0,0,255,this.c):this.pixelAtLocation(i)}},{key:"getPixel",value:function(t,e){if(!this.c)throw new Error("Requires a CamanJS context");var i=this.coordinatesToLocation(t,e,this.width);return this.pixelAtLocation(i)}},{key:"putPixel",value:function(t,e,i){if(!this.c)throw new Error("Requires a CamanJS context");var r=this.coordinatesToLocation(t,e,this.width);this.c.pixelData[r]=i.r,this.c.pixelData[r+1]=i.g,this.c.pixelData[r+2]=i.b,this.c.pixelData[r+3]=i.a}},{key:"toString",value:function(){this.toKey()}},{key:"toHex",value:function(){var t=0<arguments.length&&void 0!==arguments[0]&&arguments[0],e="#"+this.r.toString(16)+this.g.toString(16)+this.b.toString(16);return t&&(e+=this.a.toString(16)),e}}],[{key:"putPixelRelative",value:function(t,e,i){if(!this.c)throw new Error("Requires a CamanJS context");var r=this.loc+4*this.c.dimensions.width*(-1*e)+4*t;if(!(r>this.c.pixelData.length||r<0))return this.c.pixelData[r]=i.r,this.c.pixelData[r+1]=i.g,this.c.pixelData[r+2]=i.b,this.c.pixelData[r+3]=i.a,!0}}]),s}(),h=function(){function t(){l(this,t)}return i(t,null,[{key:"isRemote",value:function(t){return!!t&&(!this.corsEnabled(t)&&this.isURLRemote(t.src))}},{key:"corsEnabled",value:function(t){return t.crossOrigin&&("anonymous"===t.crossOrigin.toLowerCase()||"use-credentials"===t.crossOrigin.toLowerCase())}},{key:"isURLRemote",value:function(t){var e=t.match(this.domainRegex);return!!e&&e[1]!==document.domain}},{key:"remoteCheck",value:function(t){if(this.isURLRemote(t)){if(c.remoteProxy.length)return c.isURLRemote(c.remoteProxy)?void b.info("Cannot use a remote proxy for loading images."):this.proxyUrl(t);b.info("Attempting to load a remote image without a configured proxy. URL: //"+t)}}},{key:"proxyUrl",value:function(t){return(c.remoteProxy?c.remoteProxy:"")+" //"+c.proxyParam+"=//"+encodeURIComponent(t)}},{key:"useProxy",value:function(t){var e={ruby:"rb",python:"py",perl:"pl",javascript:"js"};return"proxies/caman_proxy."+(t=e[t=t.toLowerCase()]?e[t]:t)}}]),t}();Object.defineProperty(h,"domainRegex",{enumerable:!0,writable:!0,value:/(?:(?:http|https):\/\/)((?:\w+)\.(?:(?:\w|\.)+))/});var p=function(){function o(t){l(this,o),this.c=t,this.renderQueue=[],this.modPixelData=null}return i(o,[{key:"add",value:function(t){t&&this.renderQueue.push(t)}},{key:"processNext",value:function(){if(0===this.renderQueue.length)return s.trigger(this,"renderFinished"),this.finishedFn&&this.finishedFn.call(this.c),this;switch(this.currentJob=this.renderQueue.shift(),this.currentJob.type){case a.Type.LayerDequeue:var t=this.c.canvasQueue.shift();this.c.executeLayer(t),this.processNext();break;case a.Type.LayerFinished:this.c.applyCurrentLayer(),this.c.popContext(),this.processNext();break;case a.Type.LoadOverlay:this.loadOverlay(this.currentJob.layer,this.currentJob.src);break;case a.Type.Plugin:this.executePlugin();break;default:this.executeFilter()}}},{key:"execute",value:function(t){this.finishedFn=t,this.modPixelData=y.dataArray(this.c.pixelData.length),this.processNext()}},{key:"eachBlock",value:function(r){var n=this;this.blocksDone=0;for(var t=this.c.pixelData.length,s=4*Math.floor(t/4/o.Blocks),a=s+t/4%o.Blocks*4,e=function(t){var e=t*s,i=e+(t===o.Blocks-1?a:s);setTimeout(function(){r.call(n,t,e,i)},0)},i=0;i<o.Blocks;i++)e(i)}},{key:"executeFilter",value:function(){s.trigger(this.c,"processStart",this.currentJob),this.currentJob.type===a.Type.Single?this.eachBlock(this.renderBlock):this.eachBlock(this.renderKernel)}},{key:"executePlugin",value:function(){b.debug("Executing plugin "+this.currentJob.plugin),t.execute(this.c,this.currentJob.plugin,this.currentJob.args),b.debug("Plugin "+this.currentJob.plugin+" finished!"),this.processNext()}},{key:"renderBlock",value:function(t,e,i){b.debug("Block #"+t+" - Filter: "+this.currentJob.name+", Start: "+e+", End: "+i),s.trigger(this.c,"blockStarted",{blockNum:t,totalBlocks:o.Blocks,startPixel:e,endPixel:i});var r=new m;r.setContext(this.c);for(var n=e;n<i;n+=4)r.loc=n,r.r=this.c.pixelData[n],r.g=this.c.pixelData[n+1],r.b=this.c.pixelData[n+2],r.a=this.c.pixelData[n+3],this.currentJob.processFn(r),this.c.pixelData[n]=y.clampRGB(r.r),this.c.pixelData[n+1]=y.clampRGB(r.g),this.c.pixelData[n+2]=y.clampRGB(r.b),this.c.pixelData[n+3]=y.clampRGB(r.a);this.blockFinished(t)}},{key:"renderKernel",value:function(t,e,i){var r=this.currentJob.bias,n=this.currentJob.divisor,s=this.c.pixelData.length,a=this.currentJob.adjust,o=Math.sqrt(a.length),h=[];b.debug("Rendering kernel - Filter: "+this.currentJob.name),e=Math.max(e,4*this.c.dimensions.width*((o-1)/2)),i=Math.min(i,s-4*this.c.dimensions.width*((o-1)/2));var c=(o-1)/2,u=new m;u.setContext(this.c);for(var l=e;l<i;l+=4){u.loc=l;for(var g=0,d=-c;d<=c;d++)for(var v=c;-c<=v;v--){var f=u.getPixelRelative(d,v);h[3*g]=f.r,h[3*g+1]=f.g,h[3*g+2]=f.b,g++}var p=this.processKernel(a,h,n,r);this.modPixelData[l]=y.clampRGB(p.r),this.modPixelData[l+1]=y.clampRGB(p.g),this.modPixelData[l+2]=y.clampRGB(p.b),this.modPixelData[l+3]=this.c.pixelData[l+3]}this.blockFinished(t)}},{key:"blockFinished",value:function(t){if(0<=t&&b.debug("Block #"+t+" finished! Filter: "+this.currentJob.name),this.blocksDone++,s.trigger(this.c,"blockFinished",{blockNum:t,blocksFinished:this.blocksDone,totalBlocks:o.Blocks}),this.blocksDone===o.Blocks){if(this.currentJob.type===a.Type.Kernel)for(var e=0;e<this.c.pixelData.length;e++)this.c.pixelData[e]=this.modPixelData[e];0<=t&&b.debug("Filter "+this.currentJob.name+" finished!"),s.trigger(this.c,"processComplete",this.currentJob),this.processNext()}}},{key:"processKernel",value:function(t,e,i,r){for(var n={r:0,g:0,b:0},s=0;s<t.length;s++)n.r+=t[s]*e[3*s],n.g+=t[s]*e[3*s+1],n.b+=t[s]*e[3*s+2];return n.r=n.r/i+r,n.g=n.g/i+r,n.b=n.b/i+r,n}},{key:"loadOverlay",value:function(t,e){var i=this,r=new Image;r.onload=function(){t.context.drawImage(r,0,0,i.c.dimensions.width,i.c.dimensions.height),t.imageData=t.context.getImageData(0,0,i.c.dimensions.width,i.c.dimensions.height),t.pixelData=t.imageData.data,i.c.pixelData=t.pixelData,i.processNext()};var n=h.remoteCheck(e);r.src=n||e}}]),o}();Object.defineProperty(p,"Blocks",{enumerable:!0,writable:!0,value:4});var o=function(){function t(){l(this,t)}return i(t,null,[{key:"register",value:function(t,e){this.blenders[t]=e}},{key:"execute",value:function(t,e,i){return this.blenders[t](e,i)}}]),t}();Object.defineProperty(o,"blenders",{enumerable:!0,writable:!0,value:{}});var x=function(){function e(t){l(this,e),this.c=t,this.filter=t,this.options={blendingMode:"normal",opacity:1},this.layerID=y.uniqid().get(),this.canvas=document.createElement("canvas"),this.canvas.width=this.c.dimensions.width,this.canvas.height=this.c.dimensions.height,this.context=this.canvas.getContext("2d"),this.context.createImageData(this.canvas.width,this.canvas.height),this.imageData=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),this.pixelData=this.imageData.data}return i(e,[{key:"newLayer",value:function(t){this.c.newLayer(t)}},{key:"setBlendingMode",value:function(t){return this.options.blendingMode=t,this}},{key:"opacity",value:function(t){return this.options.opacity=t/100,this}},{key:"copyParent",value:function(){for(var t=this.pixelData,e=0;e<this.c.pixelData.length;e+=4)this.pixelData[e]=t[e],this.pixelData[e+1]=t[e+1],this.pixelData[e+2]=t[e+2],this.pixelData[e+3]=t[e+3];return this}},{key:"fillColor",value:function(){this.c.fillColor.apply(this.c,arguments)}},{key:"overlayImage",value:function(t){return"object"===(void 0===t?"undefined":u(t))?t=t.src:"string"==typeof t&&"#"===t[0]&&(t=n(t).src),t&&this.c.renderer.renderQueue.push({type:a.Type.LoadOverlay,src:t,layer:this}),this}},{key:"applyToParent",value:function(){for(var t=this.c.pixelStack[this.c.pixelStack.length-1],e=this.c.pixelData,i=0;i<e.length;i+=4){var r={r:t[i],g:t[i+1],b:t[i+2],a:t[i+3]},n={r:e[i],g:e[i+1],b:e[i+2],a:e[i+3]},s=o.execute(this.options.blendingMode,n,r);s.r=y.clampRGB(s.r),s.g=y.clampRGB(s.g),s.b=y.clampRGB(s.b),s.a||(s.a=n.a),t[i]=r.r-(r.r-s.r)*(this.options.opacity*(s.a/255)),t[i+1]=r.g-(r.g-s.g)*(this.options.opacity*(s.a/255)),t[i+2]=r.b-(r.b-s.b)*(this.options.opacity*(s.a/255))}}}]),e}(),c=function(t){function c(){for(var t=arguments.length,e=Array(t),i=0;i<t;i++)e[i]=arguments[i];if(l(this,c),0===e.length)throw new Error("Invalid arguments");var r,n=g(this,(c.__proto__||Object.getPrototypeOf(c)).call(this));if(n instanceof c){var s;if(n.finishInit=n.finishInit.bind(n),n.imageLoaded=n.imageLoaded.bind(n),!c.NodeJS){var a,o=parseInt(c.getAttrId(e[0]),10),h=void 0;if(h="function"==typeof e[1]?e[1]:"function"==typeof e[1]?e[2]:d,!isNaN(o)&&v.has(o))return a=v.execute(o,h),g(n,a)}return n.id=y.uniqid().get(),n.initializedPixelData=n.originalPixelData=null,n.cropCoordinates={x:0,y:0},n.cropped=!1,n.resized=!1,n.pixelStack=[],n.layerStack=[],n.canvasQueue=[],n.currentLayer=null,n.scaled=!1,n.analyze=new f(n),n.renderer=new p(n),n.domIsLoaded(function(){n.parseArguments(e),n.setup()}),g(s=n,s)}return r=new(Function.prototype.bind.apply(c,[null].concat(e))),g(n,r)}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(c,e),i(c,null,[{key:"toString",value:function(){return"Version "+c.version.release+", Released "+c.version.date}},{key:"getAttrId",value:function(t){return!!c.NodeJS||("string"==typeof t&&(t=n(t)),t&&t.getAttribute?t.getAttribute("data-caman-id"):null)}}]),i(c,[{key:"domIsLoaded",value:function(t){var e=this;if(c.NodeJS)setTimeout(function(){t.call(e)},0);else if("complete"===document.readyState)b.debug("DOM initialized"),setTimeout(function(){t.call(e)},0);else{document.addEventListener("readystatechange",function(){"complete"===document.readyState&&(b.debug("DOM initialized"),t.call(e))},!1)}}},{key:"parseArguments",value:function(t){if(0===t.length)throw new Error("Invalid arguments given");if(this.initObj=null,this.initType=null,this.imageUrl=null,this.callback=d,this.setInitObject(t[0]),1!==t.length){switch(u(t[1])){case"string":this.imageUrl=t[1];break;case"function":this.callback=t[1]}if(2!==t.length&&(this.callback=t[2],4===t.length))for(var e in t[4])t[4].hasOwnProperty(e)&&(this.options[e]=t[4][e])}}},{key:"setInitObject",value:function(t){if(c.NodeJS)return this.initObj=t,void(this.initType="node");if("object"===(void 0===t?"undefined":u(t))?this.initObj=t:this.initObj=n(t),!this.initObj)throw new Error("Could not find image or canvas for initialization.");this.initType=this.initObj.nodeName.toLowerCase()}},{key:"setup",value:function(){switch(console.log(this.initType),this.initType){case"node":this.initNode();break;case"img":this.initImage();break;case"canvas":this.initCanvas()}}},{key:"initNode",value:function(){}},{key:"initImage",value:function(){this.image=this.initObj,this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),y.copyAttributes(this.image,this.canvas,{except:["src"]}),this.image.parentNode&&this.image.parentNode.replaceChild(this.canvas,this.image),this.imageAdjustments(),this.waitForImageLoaded()}},{key:"initCanvas",value:function(){this.canvas=this.initObj,console.log(this.canvas),this.context=this.canvas.getContext("2d"),this.imageUrl?(this.image=document.createElement("img"),this.image.src=this.imageUrl,this.imageAdjustments(),this.waitForImageLoaded()):this.finishInit()}},{key:"imageAdjustments",value:function(){h.isRemote(this.image)&&(this.image.src=h.proxyUrl(this.image.src),b.debug("Remote image detected, using URL = "+this.image.src))}},{key:"waitForImageLoaded",value:function(){this.isImageLoaded()?this.imageLoaded():this.image.onload=this.imageLoaded}},{key:"isImageLoaded",value:function(){return!!this.image.complete&&(!this.image.naturalWidth||0!==this.image.naturalWidth)}},{key:"imageWidth",value:function(){return this.image.width||this.image.naturalWidth}},{key:"imageHeight",value:function(){return this.image.height||this.image.naturalHeight}},{key:"imageLoaded",value:function(){b.debug("Image loaded. Width = "+this.imageWidth()+", Height = "+this.imageHeight()),this.canvas.width=this.imageWidth(),this.canvas.height=this.imageHeight(),this.finishInit()}},{key:"finishInit",value:function(){if(this.context||(this.context=this.canvas.getContext("2d")),this.originalWidth=this.preScaledWidth=this.width=this.canvas.width,this.originalHeight=this.preScaledHeight=this.height=this.canvas.height,this.hasId()||this.assignId(),this.image&&this.context.drawImage(this.image,0,0,this.imageWidth(),this.imageHeight(),0,0,this.preScaledWidth,this.preScaledHeight),this.imageData=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),this.pixelData=this.imageData.data,c.allowRevert){this.initializedPixelData=y.dataArray(this.pixelData.length),this.originalPixelData=y.dataArray(this.pixelData.length);for(var t=0;t<this.pixelData.length;t++){var e=this.pixelData[t];this.initializedPixelData[t]=e,this.originalPixelData[t]=e}}this.dimensions={width:this.canvas.width,height:this.canvas.height},c.NodeJS||v.put(this.id,this),this.callback(this),this.callback=d}},{key:"reloadCanvasData",value:function(){this.imageData=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),this.pixelData=this.imageData.data}},{key:"resetOriginalPixelData",value:function(){if(!c.allowRevert)throw new Error("Revert disabled");this.originalPixelData=y.dataArray(this.pixelData.length);for(var t=0;t<this.pixelData.length;t++){var e=this.pixelData[t];this.originalPixelData[t]=e}}},{key:"hasId",value:function(){return!!c.getAttrId(this.canvas)}},{key:"assignId",value:function(){c.NodeJS||this.canvas.getAttribute("data-caman-id")||this.canvas.setAttribute("data-caman-id",this.id)}},{key:"replaceCanvas",value:function(t){var e=this.canvas;this.canvas=t,this.context=this.canvas.getContext("2d"),c.NodeJS||e.parentNode.replaceChild(this.canvas,e),this.width=this.canvas.width,this.height=this.canvas.height,this.reloadCanvasData(),this.dimensions={width:this.canvas.width,height:this.canvas.height}}},{key:"render",value:function(){var t=this,e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:d;s.trigger(this,"renderStart"),this.renderer.execute(function(){t.context.putImageData(t.imageData,0,0),e.call(t)})}},{key:"revert",value:function(){var t=!(0<arguments.length&&void 0!==arguments[0])||arguments[0];if(!c.allowRevert)throw new Error("Revert disabled");for(var e=this.originalVisiblePixels(),i=0,r=e.length;i<r;i++){var n=e[i];this.pixelData[i]=n}t&&this.context.putImageData(this.imageData,0,0)}},{key:"reset",value:function(){var t=document.createElement("canvas");y.copyAttributes(this.canvas,t),t.width=this.originalWidth,t.height=this.originalHeight;for(var e=t.getContext("2d"),i=e.getImageData(0,0,t.width,t.height),r=i.data,n=0;n<this.initializedPixelData.length;n++){var s=this.initializedPixelData[n];r[n]=s}e.putImageData(i,0,0),this.cropCoordinates={x:0,y:0},this.resized=!1,this.replaceCanvas(t)}},{key:"originalVisiblePixels",value:function(){if(!c.allowRevert)throw new Error("Revert disabled");return[]}},{key:"process",value:function(t,e){return this.renderer.add({type:a.Type.Single,name:t,processFn:e}),this}},{key:"processKernel",value:function(t,e){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null,r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0;if(!i)for(var n=i=0;n<=e.length;n++)i+=e[n];return this.renderer.add({type:a.Type.Kernel,name:t,adjust:e,divisor:i,bias:r}),this}},{key:"processPlugin",value:function(t,e){return this.renderer.add({type:a.Type.Plugin,plugin:t,args:e}),this}},{key:"newLayer",value:function(t){var e=new x(this);return this.canvasQueue.push(e),this.renderer.add({type:a.Type.LayerDequeue}),t.call(e),this.renderer.add({type:a.Type.LayerFinished}),this}},{key:"executeLayer",value:function(t){this.pushContext(t)}},{key:"pushContext",value:function(t){this.layerStack.push(this.currentLayer),this.pixelStack.push(this.pixelData),this.currentLayer=t,this.pixelData=t.pixelData}},{key:"popContext",value:function(){this.pixelData=this.pixelStack.pop(),this.currentLayer=this.layerStack.pop()}},{key:"applyCurrentLayer",value:function(){this.currentLayer.applyToParent()}},{key:"save",value:function(){exports?this.nodeSave.apply(this,arguments):this.browserSave.apply(this,arguments)}},{key:"browserSave",value:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"png";t=t.toLowerCase();var e=this.toBase64(t).replace("image/"+t,"image/octet-stream");document.location.href=e}},{key:"toImage",value:function(t){var e=new Image;return e.src=this.toBase64(t),e.width=this.dimensions.width,e.height=this.dimensions.height,window.devicePixelRatio&&(e.width/=window.devicePixelRatio,e.height/=window.devicePixelRatio),e}},{key:"toBase64",value:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"png";return t=t.toLowerCase(),this.canvas.toDataURL("image/"+t)}}]),c}();Object.defineProperty(c,"version",{enumerable:!0,writable:!0,value:{release:"1.0.0",date:"6/08/2018"}}),Object.defineProperty(c,"DEBUG",{enumerable:!0,writable:!0,value:!0}),Object.defineProperty(c,"allowRevert",{enumerable:!0,writable:!0,value:!0}),Object.defineProperty(c,"crossOrigin",{enumerable:!0,writable:!0,value:"anonymous"}),Object.defineProperty(c,"remoteProxy",{enumerable:!0,writable:!0,value:""}),Object.defineProperty(c,"proxyParam",{enumerable:!0,writable:!0,value:"camanProxyUrl"}),Object.defineProperty(c,"NodeJS",{enumerable:!0,writable:!0,value:"undefined"!=typeof exports}),Object.defineProperty(c,"wechat",{enumerable:!0,writable:!0,value:"undefined"!=typeof exports}),Object.defineProperty(c,"autoload",{enumerable:!0,writable:!0,value:!c.NodeJS});var w=function(){function t(){l(this,t)}return i(t,null,[{key:"hexToRGB",value:function(t){return"#"===t.charAt(0)&&(t=t.substr(1)),{r:parseInt(t.substr(0,2),16),g:parseInt(t.substr(2,2),16),b:parseInt(t.substr(4,2),16)}}},{key:"rgbToHSL",value:function(t,e,i){"object"===(void 0===t?"undefined":u(t))&&(e=t.g,i=t.b,t=t.r),t/=255,e/=255,i/=255;var r=Math.max(t,e,i),n=Math.min(t,e,i),s=(r+n)/2,a=void 0,o=void 0;if(r===n)a=o=0;else{var h=r-n;o=.5<s?h/(2-r-n):h/(r+n),r===t?a=(e-i)/h+e<i?6:0:r===e?a=(i-t)/h+2:r===i&&(a=(t-e)/h+4),a/=6}return{h:a,s:o,l:s}}},{key:"hslToRGB",value:function(t,e,i){var r=void 0,n=void 0,s=void 0,a=void 0,o=void 0;return"object"===(void 0===t?"undefined":u(t))&&(e=t.s,i=t.l,t=t.h),0===e?r=n=s=i:(a=2*i-(o=i<.5?i*(1+e):i+e-i*e),r=this.hueToRGB(a,o,t+1/3),n=this.hueToRGB(a,o,t),s=this.hueToRGB(a,o,t-1/3)),{r:255*r,g:255*n,b:255*s}}},{key:"hueToRGB",value:function(t,e,i){return i<0&&(i+=1),1<i&&(i-=1),i<1/6?t+6*(e-t)*i:i<.5?e:i<2/3?t+(e-t)*(2/3-i)*6:t}},{key:"rgbToHSV",value:function(t,e,i){t/=255,e/=255,i/=255;var r=Math.max(t,e,i),n=Math.min(t,e,i),s=r-n,a=void 0;return r===n?a=0:(r===t?a=(e-i)/s+e<i?6:0:r===e?a=(i-t)/s+2:r===i&&(a=(t-e)/s+4),a/=6),{h:a,s:0===r?0:s/r,v:r}}},{key:"hsvToRGB",value:function(t,e,i){var r=Math.floor(6*t),n=6*t-r,s=i*(1-e),a=i*(1-n*e),o=i*(1-(1-n)*e),h=void 0,c=void 0,u=void 0;switch(r%6){case 0:h=i,c=o,u=s;break;case 1:h=a,c=i,u=s;break;case 2:h=s,c=i,u=o;break;case 3:h=s,c=a,u=i;break;case 4:h=o,c=s,u=i;break;case 5:h=i,c=s,u=a}return{r:Math.floor(255*h),g:Math.floor(255*c),b:Math.floor(255*u)}}},{key:"rgbToXYZ",value:function(t,e,i){return e/=255,i/=255,.04045<(t/=255)?t=Math.pow((t+.055)/1.055,2.4):t/=12.92,.04045<e?e=Math.pow((e+.055)/1.055,2.4):e/=12.92,.04045<i?i=Math.pow((i+.055)/1.055,2.4):i/=12.92,{x:100*(.4124*t+.3576*e+.1805*i),y:100*(.2126*t+.7152*e+.0722*i),z:100*(.0193*t+.1192*e+.9505*i)}}},{key:"xyzToRGB",value:function(t,e,i){var r=3.2406*(t/=100)+-1.5372*(e/=100)+-.4986*(i/=100),n=-.9689*t+1.8758*e+.0415*i,s=.0557*t+-.204*e+1.057*i;return.0031308<r?r=1.055*Math.pow(r,.4166666667)-.055:r*=12.92,.0031308<n?n=1.055*Math.pow(n,.4166666667)-.055:n*=12.92,.0031308<s?s=1.055*Math.pow(s,.4166666667)-.055:s*=12.92,{r:255*r,g:255*n,b:255*s}}},{key:"xyzToLab",value:function(t,e,i){"object"===(void 0===t?"undefined":u(t))&&(e=t.y,i=t.z,t=t.x);return e/=100,i/=108.883,t=.008856451679<(t/=95.047)?Math.pow(t,.3333333333):7.787037037*t+.1379310345,{l:116*(e=.008856451679<e?Math.pow(e,.3333333333):7.787037037*e+.1379310345)-16,a:500*(t-e),b:200*(e-(i=.008856451679<i?Math.pow(i,.3333333333):7.787037037*i+.1379310345))}}},{key:"labToXYZ",value:function(t,e,i){"object"===(void 0===t?"undefined":u(t))&&(e=t.a,i=t.b,t=t.l);var r=(t+16)/116,n=r+e/500,s=r-i/200;return.2068965517<n?n*=n*n:n=.1284185493*(n-.1379310345),.2068965517<r?r*=r*r:r=.1284185493*(r-.1379310345),.2068965517<s?s*=s*s:s=.1284185493*(s-.1379310345),{x:95.047*n,y:100*r,z:108.883*s}}},{key:"rgbToLab",value:function(t,e,i){"object"===(void 0===t?"undefined":u(t))&&(e=t.g,i=t.b,t=t.r);var r=this.rgbToXYZ(t,e,i);return this.xyzToLab(r)}}]),t}(),k=function(){function v(){l(this,v)}return i(v,null,[{key:"distance",value:function(t,e,i,r){return Math.sqrt(Math.pow(i-t,2)+Math.pow(r-e,2))}},{key:"randomRange",value:function(t,e){var i=2<arguments.length&&void 0!==arguments[2]&&arguments[2],r=t+Math.random()*(e-t);return i?r.toFixed(i):Math.round(r)}},{key:"luminance",value:function(t){return.299*t.r+.587*t.g+.114*t.b}},{key:"bezier",value:function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:255;if(t.length<2)throw new Error("Invalid number of arguments to bezier");for(var r,n,s,a={},o=function(t,e,i){return t*(1-i)+e*i},h=0;h<1e3;h++){for(var c=h/1e3,u=t;1<u.length;){for(var l=[],g=0;g<=u.length-2;g++)l.push([o(u[g][0],u[g+1][0],c),o(u[g][1],u[g+1][1],c)]);u=l}a[Math.round(u[0][0])]=Math.round((r=u[0][1],n=e,s=i,Math.min(Math.max(r,n),s)))}var d=t[t.length-1][0];return a=v.missingValues(a,d),a[d]||(a[d]=a[d-1]),a}},{key:"missingValues",value:function(t,e){if(Object.keys(t).length<e+1){for(var i={},r=void 0,n=void 0,s=0;s<=e;s++)if(t[s])i[s]=t[s];else{r=[s-1,i[s-1]];for(var a=s;a<=e;a++)if(t[a]){n=[a,t[a]];break}i[s]=r[1]+(n[1]-r[1])/(n[0]-r[0])*(s-r[0])}return i}return t}}]),v}();var D={brightness:function(t,e,i){return t.r=t.r-t.r*e*i.strength,t.g=t.g-t.g*e*i.strength,t.b=t.b-t.b*e*i.strength,t},gamma:function(t,e,i){return t.r=255*Math.pow(t.r/255,Math.max(10*e*i.strength,1)),t.g=255*Math.pow(t.g/255,Math.max(10*e*i.strength,1)),t.b=255*Math.pow(t.b/255,Math.max(10*e*i.strength,1)),t},colorize:function(t,e,i){return t.r-=(t.r-i.color.r)*e,t.g-=(t.g-i.color.g)*e,t.b-=(t.b-i.color.b)*e,t}};var M,P,R,B,L,S,K=void 0,W=void 0,V=void 0;return W=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259],V=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24],K=function(){this.r=0,this.g=0,this.b=0,this.a=0,this.next=null},(M=o).register("normal",function(t,e){return{r:t.r,g:t.g,b:t.b}}),M.register("multiply",function(t,e){return{r:t.r*e.r/255,g:t.g*e.g/255,b:t.b*e.b/255}}),M.register("screen",function(t,e){return{r:255-(255-t.r)*(255-e.r)/255,g:255-(255-t.g)*(255-e.g)/255,b:255-(255-t.b)*(255-e.b)/255}}),M.register("overlay",function(t,e){var i={};return i.r=128<e.r?255-2*(255-t.r)*(255-e.r)/255:e.r*t.r*2/255,i.g=128<e.g?255-2*(255-t.g)*(255-e.g)/255:e.g*t.g*2/255,i.b=128<e.b?255-2*(255-t.b)*(255-e.b)/255:e.b*t.b*2/255,i}),M.register("difference",function(t,e){return{r:t.r-e.r,g:t.g-e.g,b:t.b-e.b}}),M.register("addition",function(t,e){return{r:e.r+t.r,g:e.g+t.g,b:e.b+t.b}}),M.register("exclusion",function(t,e){return{r:128-2*(e.r-128)*(t.r-128)/255,g:128-2*(e.g-128)*(t.g-128)/255,b:128-2*(e.b-128)*(t.b-128)/255}}),M.register("softLight",function(t,e){var i={};return i.r=128<e.r?255-(255-e.r)*(255-(t.r-128))/255:e.r*(t.r+128)/255,i.g=128<e.g?255-(255-e.g)*(255-(t.g-128))/255:e.g*(t.g+128)/255,i.b=128<e.b?255-(255-e.b)*(255-(t.b-128))/255:e.b*(t.b+128)/255,i}),M.register("lighten",function(t,e){return{r:e.r>t.r?e.r:t.r,g:e.g>t.g?e.g:t.g,b:e.b>t.b?e.b:t.b}}),M.register("darken",function(t,e){return{r:e.r>t.r?t.r:e.r,g:e.g>t.g?t.g:e.g,b:e.b>t.b?t.b:e.b}}),(P=a).register("fillColor",function(){var e=void 0;e=1===arguments.length?w.hexToRGB(arguments.length<=0?void 0:arguments[0]):{r:arguments.length<=0?void 0:arguments[0],g:arguments.length<=1?void 0:arguments[1],b:arguments.length<=2?void 0:arguments[2]},this.process("fillColor",function(t){return t.r=e.r,t.g=e.g,t.b=e.b,t.a=255,t})}),P.register("brightness",function(e){e=Math.floor(e/100*255),this.process("brightness",function(t){return t.r+=e,t.g+=e,t.b+=e,t})}),P.register("saturation",function(i){i*=-.01,this.process("saturation",function(t){var e=Math.max(t.r,t.g,t.b);return t.r!==e&&(t.r+=(e-t.r)*i),t.g!==e&&(t.g+=(e-t.g)*i),t.b!==e&&(t.b+=(e-t.b)*i),t})}),P.register("vibrance",function(n){n*=-1,this.process("vibrance",function(t){var e=Math.max(t.r,t.g,t.b),i=(t.r+t.g+t.b)/3,r=2*Math.abs(e-i)/255*n/100;return t.r!==e&&(t.r+=(e-t.r)*r),t.g!==e&&(t.g+=(e-t.g)*r),t.b!==e&&(t.b+=(e-t.b)*r),t})}),P.register("greyscale",function(){this.process("greyscale",function(t){var e=k.luminance(t);return t.r=e,t.g=e,t.b=e,t})}),P.register("contrast",function(e){e=Math.pow((e+100)/100,2),this.process("contrast",function(t){return t.r/=255,t.r-=.5,t.r*=e,t.r+=.5,t.r*=255,t.g/=255,t.g-=.5,t.g*=e,t.g+=.5,t.g*=255,t.b/=255,t.b-=.5,t.b*=e,t.b+=.5,t.b*=255,t})}),P.register("hue",function(o){this.process("hue",function(t){var e=w.rgbToHSV(t.r,t.g,t.b),i=100*e.h;i+=Math.abs(o),i%=100,i/=100,e.h=i;var r=w.hsvToRGB(e.h,e.s,e.v),n=r.r,s=r.g,a=r.b;return t.r=n,t.g=s,t.b=a,t})}),P.register("colorize",function(){var e=void 0,i=void 0;2===arguments.length?(e=w.hexToRGB(arguments.length<=0?void 0:arguments[0]),i=arguments.length<=1?void 0:arguments[1]):4===arguments.length&&(e={r:arguments.length<=0?void 0:arguments[0],g:arguments.length<=1?void 0:arguments[1],b:arguments.length<=2?void 0:arguments[2]},i=arguments.length<=3?void 0:arguments[3]),this.process("colorize",function(t){return t.r-=(t.r-e.r)*(i/100),t.g-=(t.g-e.g)*(i/100),t.b-=(t.b-e.b)*(i/100),t})}),P.register("invert",function(){this.process("invert",function(t){return t.r=255-t.r,t.g=255-t.g,t.b=255-t.b,t})}),P.register("sepia",function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:100;e/=100,this.process("sepia",function(t){return t.r=Math.min(255,t.r*(1-.607*e)+t.g*(.769*e)+t.b*(.189*e)),t.g=Math.min(255,t.r*(.349*e)+t.g*(1-.314*e)+t.b*(.168*e)),t.b=Math.min(255,t.r*(.272*e)+t.g*(.534*e)+t.b*(1-.869*e)),t})}),P.register("gamma",function(e){this.process("gamma",function(t){return t.r=255*Math.pow(t.r/255,e),t.g=255*Math.pow(t.g/255,e),t.b=255*Math.pow(t.b/255,e),t})}),P.register("noise",function(i){i=2.55*Math.abs(i),this.process("noise",function(t){var e=k.randomRange(-1*i,i);return t.r+=e,t.g+=e,t.b+=e,t})}),P.register("clip",function(e){e=2.55*Math.abs(e),this.process("clip",function(t){return t.r>255-e?t.r=255:t.r<e&&(t.r=0),t.g>255-e?t.g=255:t.g<e&&(t.g=0),t.b>255-e?t.b=255:t.b<e&&(t.b=0),t})}),P.register("channels",function(e){if("object"!==(void 0===e?"undefined":u(e)))return this;for(var t in e)if(e.hasOwnProperty(t)){if(0===e[t]){delete e[t];continue}e[t]/=100}if(0===e.length)return this;this.process("channels",function(t){return e.red&&(0<e.red?t.r+=(255-t.r)*e.red:t.r-=t.r*Math.abs(e.red)),e.green&&(0<e.green?t.g+=(255-t.g)*e.green:t.g-=t.g*Math.abs(e.green)),e.blue&&(0<e.blue?t.b+=(255-t.b)*e.blue:t.b-=t.b*Math.abs(e.blue)),t})}),P.register("curves",function(i){for(var t=arguments.length,e=Array(1<t?t-1:0),r=1;r<t;r++)e[r-1]=arguments[r];var n=e[e.length-1],s=void 0;if("function"==typeof n?(s=n,e.pop()):"string"==typeof n?(s=k[n],e.pop()):s=k.bezier,"string"==typeof i&&(i=i.split("")),"v"===i[0]&&(i=["r","g","b"]),e.length<2)throw new Error("Invalid number of arguments to curves filter");var a=s(e,0,255),o=e[0];if(0<o[0])for(var h=0;h<o[0];h++)a[h]=o[1];var c=e[e.length-1];if(c[0]<255)for(var u=c[0];u<=255;u++)a[u]=c[1];this.process("curves",function(t){for(var e=0;e<i.length;e++)t[i[e]]=a[t[i[e]]];return t})}),P.register("exposure",function(t){var e=Math.abs(t)/100,i=[0,255*e],r=[255-255*e,255];t<0&&(i=i.reverse(),r=r.reverse()),this.curves("rgb",[0,0],i,r,[255,255])}),t.register("stackBlur",function(t){var e,i,r,n,s,a,o,h,c,u,l=void 0,g=void 0,d=void 0,v=void 0,f=void 0,p=void 0,y=void 0,b=void 0,m=void 0,x=void 0,w=void 0,k=void 0,D=void 0,M=void 0,P=void 0,R=void 0,B=void 0,L=void 0,S=void 0,C=void 0,O=void 0,j=void 0,I=void 0,z=void 0,T=void 0,A=void 0,J=void 0,N=void 0,E=void 0,F=void 0,G=void 0,U=void 0,q=void 0,H=void 0;if(!(isNaN(t)||t<1)){for(t|=0,w=this.pixelData,e=t+t+1,u=(c=this.dimensions.width)-1,r=(i=this.dimensions.height)-1,h=(s=t+1)*(s+1)/2,B=o=new K,y=A=1;1<=e?A<e:e<A;y=1<=e?++A:--A)B=B.next=new K,y===s&&(L=B);for(B.next=o,C=S=null,T=I=0,n=W[t],a=V[t],j=J=0;0<=i?J<i:i<J;j=0<=i?++J:--J){for(D=v=l=P=p=d=0,M=s*(k=w[I]),f=s*(x=w[I+1]),g=s*(m=w[I+2]),P+=h*k,p+=h*x,d+=h*m,B=o,y=N=0;0<=s?N<s:s<N;y=0<=s?++N:--N)B.r=k,B.g=x,B.b=m,B=B.next;for(y=E=1;1<=s?E<s:s<E;y=1<=s?++E:--E)b=I+((u<y?u:y)<<2),P+=(B.r=k=w[b])*(R=s-y),p+=(B.g=x=w[b+1])*R,d+=(B.b=m=w[b+2])*R,D+=k,v+=x,l+=m,B=B.next;for(S=o,C=L,O=F=0;0<=c?F<c:c<F;O=0<=c?++F:--F)w[I]=P*n>>a,w[I+1]=p*n>>a,w[I+2]=d*n>>a,P-=M,p-=f,d-=g,M-=S.r,f-=S.g,g-=S.b,b=T+((b=O+t+1)<u?b:u)<<2,P+=D+=S.r=w[b],p+=v+=S.g=w[b+1],d+=l+=S.b=w[b+2],S=S.next,M+=k=C.r,f+=x=C.g,g+=m=C.b,D-=k,v-=x,l-=m,C=C.next,I+=4;T+=c}for(O=G=0;0<=c?G<c:c<G;O=0<=c?++G:--G){for(v=l=D=p=d=P=0,M=s*(k=w[I=O<<2]),f=s*(x=w[I+1]),g=s*(m=w[I+2]),P+=h*k,p+=h*x,d+=h*m,B=o,y=U=0;0<=s?U<s:s<U;y=0<=s?++U:--U)B.r=k,B.g=x,B.b=m,B=B.next;for(z=c,y=q=1;1<=t?q<=t:t<=q;y=1<=t?++q:--q)I=z+O<<2,P+=(B.r=k=w[I])*(R=s-y),p+=(B.g=x=w[I+1])*R,d+=(B.b=m=w[I+2])*R,D+=k,v+=x,l+=m,B=B.next,y<r&&(z+=c);for(I=O,S=o,C=L,j=H=0;0<=i?H<i:i<H;j=0<=i?++H:--H)w[b=I<<2]=P*n>>a,w[b+1]=p*n>>a,w[b+2]=d*n>>a,P-=M,p-=f,d-=g,M-=S.r,f-=S.g,g-=S.b,b=O+((b=j+s)<r?b:r)*c<<2,P+=D+=S.r=w[b],p+=v+=S.g=w[b+1],d+=l+=S.b=w[b+2],S=S.next,M+=k=C.r,f+=x=C.g,g+=m=C.b,D-=k,v-=x,l-=m,C=C.next,I+=c}return this}}),(B=R=a).register("vignette",function(n){var s,a,o,t,h=1<arguments.length&&void 0!==arguments[1]?arguments[1]:60;"string"==typeof n&&"%"===n.substr(-1)&&(n=this.dimensions.height>this.dimensions.width?this.dimensions.width*(parseInt(n.substr(0,n.length-1),10)/100):this.dimensions.height*(parseInt(n.substr(0,n.length-1),10)/100)),h/=100,a=[this.dimensions.width/2,this.dimensions.height/2],t=Math.sqrt(Math.pow(a[0],2)+Math.pow(a[1],2)),o=t-n,s=k.bezier([0,1],[30,30],[70,60],[100,80]),this.process("vignette",function(t){var e,i,r;return r=t.locationXY(),e=k.distance(r.x,r.y,a[0],a[1]),o<e&&(i=Math.max(1,s[Math.round((e-o)/n*100)]/10*h),t.r=255*Math.pow(t.r/255,i),t.g=255*Math.pow(t.g/255,i),t.b=255*Math.pow(t.b/255,i)),t})}),B.register("rectangularVignette",function(r){var t,e=void 0,i=void 0,n=void 0,s=void 0,a=void 0,o=void 0;if(t={strength:50,cornerRadius:0,method:"brightness",color:{r:0,g:0,b:0}},!(r=y.extend(t,r)).size)return this;if("string"==typeof r.size)i=parseInt(r.size,10)/100,r.size={width:this.dimensions.width*i,height:this.dimensions.height*i};else if("object"===u(r.size))for(s=0,a=(o=["width","height"]).length;s<a;s++)e=o[s],"string"==typeof r.size[e]&&(r.size[e]=this.dimensions[e]*(parseInt(r.size[e],10)/100));else"number"===r.size&&(n=r.size,r.size={width:n,height:n});"string"==typeof r.cornerRadius&&(r.cornerRadius=r.size.width/2*(parseInt(r.cornerRadius,10)/100)),r.strength/=100,r.size.width=Math.floor(r.size.width),r.size.height=Math.floor(r.size.height),r.image={width:this.dimensions.width,height:this.dimensions.height},"colorize"===r.method&&"string"==typeof r.color&&(r.color=w.hexToRGB(r.color)),r.coords={left:(this.dimensions.width-r.size.width)/2,right:this.dimensions.width-r.coords.left,bottom:(this.dimensions.height-r.size.height)/2,top:this.dimensions.height-r.coords.bottom},r.corners=[{x:r.coords.left+r.cornerRadius,y:r.coords.top-r.cornerRadius},{x:r.coords.right-r.cornerRadius,y:r.coords.top-r.cornerRadius},{x:r.coords.right-r.cornerRadius,y:r.coords.bottom+r.cornerRadius},{x:r.coords.left+r.cornerRadius,y:r.coords.bottom+r.cornerRadius}],r.maxDist=k.distance(0,0,r.corners[3].x,r.corners[3].y)-r.cornerRadius,this.process("rectangularVignette",function(t){var e,i;return(i=t.locationXY()).x>r.corners[0].x&&i.x<r.corners[1].x&&i.y>r.coords.bottom&&i.y<r.coords.top?t:i.x>r.coords.left&&i.x<r.coords.right&&i.y>r.corners[3].y&&i.y<r.corners[2].y?t:(i.x>r.corners[0].x&&i.x<r.corners[1].x&&i.y>r.coords.top?e=(i.y-r.coords.top)/r.maxDist:i.y>r.corners[2].y&&i.y<r.corners[1].y&&i.x>r.coords.right?e=(i.x-r.coords.right)/r.maxDist:i.x>r.corners[0].x&&i.x<r.corners[1].x&&i.y<r.coords.bottom?e=(r.coords.bottom-i.y)/r.maxDist:i.y>r.corners[2].y&&i.y<r.corners[1].y&&i.x<r.coords.left?e=(r.coords.left-i.x)/r.maxDist:i.x<=r.corners[0].x&&i.y>=r.corners[0].y?e=(k.distance(i.x,i.y,r.corners[0].x,r.corners[0].y)-r.cornerRadius)/r.maxDist:i.x>=r.corners[1].x&&i.y>=r.corners[1].y?e=(k.distance(i.x,i.y,r.corners[1].x,r.corners[1].y)-r.cornerRadius)/r.maxDist:i.x>=r.corners[2].x&&i.y<=r.corers[2].y?e=(k.distance(i.x,i.y,r.corners[2].x,r.corners[2].y)-r.cornerRadius)/r.maxDist:i.x<=r.corners[3].x&&i.y<=r.corners[3].y&&(e=(k.distance(i.x,i.y,r.corners[3].x,r.corners[3].y)-r.cornerRadius)/r.maxDist),e<0?t:D[r.method](t,e,r))})}),(L=R).register("boxBlur",function(){this.processKernel("Box Blur",[1,1,1,1,1,1,1,1,1])}),L.register("heavyRadialBlur",function(){this.processKernel("Heavy Radial Blur",[0,0,1,0,0,0,1,1,1,0,1,1,1,1,1,0,1,1,1,0,0,0,1,0,0])}),L.register("gaussianBlur",function(){this.processKernel("Gaussian Blur",[1,4,6,4,1,4,16,24,16,4,6,24,36,24,6,4,16,24,16,4,1,4,6,4,1])}),L.register("motionBlur",function(t){var e=void 0;e=0===t||180===t?[0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0]:0<t&&t<90||180<t&&t<270?[0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0]:90===t||270===t?[0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0]:[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1],this.processKernel("Motion Blur",e)}),L.register("sharpen",function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:100;t/=100,this.processKernel("Sharpen",[0,-t,0,-t,4*t+1,-t,0,-t,0])}),R.register("posterize",function(t){var e,i;e=256/t,i=255/(t-1),this.process("posterize",function(t){return t.r=Math.floor(Math.floor(t.r/e)*i),t.g=Math.floor(Math.floor(t.g/e)*i),t.b=Math.floor(Math.floor(t.b/e)*i),t})}),(S=R).register("vintage",function(){var t=!(0<arguments.length&&void 0!==arguments[0])||arguments[0];this.greyscale(),this.contrast(5),this.noise(3),this.sepia(100),this.channels({red:8,blue:2,green:4}),this.gamma(.87),t&&this.vignette("40%",30)}),S.register("lomo",function(){var t=!(0<arguments.length&&void 0!==arguments[0])||arguments[0];this.brightness(15),this.exposure(15),this.curves("rgb",[0,0],[200,0],[155,255],[255,255]),this.saturation(-20),this.gamma(1.8),t&&this.vignette("50%",60),this.brightness(5)}),S.register("clarity",function(){var t=0<arguments.length&&void 0!==arguments[0]&&arguments[0];return this.vibrance(20),this.curves("rgb",[5,0],[130,150],[190,220],[250,255]),this.sharpen(15),this.vignette("45%",20),t&&(this.greyscale(),this.contrast(4)),this}),S.register("sinCity",function(){this.contrast(100),this.brightness(15),this.exposure(10),this.posterize(80),this.clip(30),this.greyscale()}),S.register("sunrise",function(){this.exposure(3.5),this.saturation(-5),this.vibrance(50),this.sepia(60),this.colorize("#e87b22",10),this.channels({red:8,blue:8}),this.contrast(5),this.gamma(1.2),this.vignette("55%",25)}),S.register("crossProcess",function(){this.exposure(5),this.colorize("#e87b22",4),this.sepia(20),this.channels({blue:8,red:3}),this.curves("b",[0,0],[100,150],[180,180],[255,255]),this.contrast(15),this.vibrance(75),this.gamma(1.6)}),S.register("orangePeel",function(){this.curves("rgb",[0,0],[100,50],[140,200],[255,255]),this.vibrance(-30),this.saturation(-30),this.colorize("#ff9000",30),this.contrast(-5),this.gamma(1.4)}),S.register("love",function(){this.brightness(5),this.exposure(8),this.contrast(4),this.colorize("#c42007",30),this.vibrance(50),this.gamma(1.3)}),S.register("grungy",function(){this.gamma(1.5),this.clip(25),this.saturation(-60),this.contrast(5),this.noise(5),this.vignette("50%",30)}),S.register("jarques",function(){this.saturation(-35),this.curves("b",[20,0],[90,120],[186,144],[255,230]),this.curves("r",[0,0],[144,90],[138,120],[255,255]),this.curves("g",[10,0],[115,105],[148,100],[255,248]),this.curves("rgb",[0,0],[120,100],[128,140],[255,255]),this.sharpen(20)}),S.register("pinhole",function(){this.greyscale(),this.sepia(10),this.exposure(10),this.contrast(15),this.vignette("60%",35)}),S.register("oldBoot",function(){return this.saturation(-20),this.vibrance(-50),this.gamma(1.1),this.sepia(30),this.channels({red:-10,blue:5}),this.curves("rgb",[0,0],[80,50],[128,230],[255,255]),this.vignette("60%",30)}),S.register("glowingSun",function(){var t=!(0<arguments.length&&void 0!==arguments[0])||arguments[0];if(this.brightness(10),this.newLayer(function(){return this.setBlendingMode("multiply"),this.opacity(80),this.copyParent(),this.filter.gamma(.8),this.filter.contrast(50),this.filter.exposure(10)}),this.newLayer(function(){return this.setBlendingMode("softLight"),this.opacity(80),this.fillColor("#f49600")}),this.exposure(20),this.gamma(.8),t)return this.vignette("45%",20)}),S.register("hazyDays",function(){this.gamma(1.2),this.newLayer(function(){this.setBlendingMode("overlay"),this.opacity(60),this.copyParent(),this.filter.channels({red:5}),this.filter.stackBlur(15)}),this.newLayer(function(){this.setBlendingMode("addition"),this.opacity(40),this.fillColor("#6899ba")}),this.newLayer(function(){this.setBlendingMode("multiply"),this.opacity(35),this.copyParent(),this.filter.brightness(40),this.filter.vibrance(40),this.filter.exposure(30),this.filter.contrast(15),this.filter.curves("r",[0,40],[128,128],[128,128],[255,215]),this.filter.curves("g",[0,40],[128,128],[128,128],[255,215]),this.filter.curves("b",[0,40],[128,128],[128,128],[255,215]),this.filter.stackBlur(5)}),this.curves("r",[20,0],[128,158],[128,128],[235,255]),this.curves("g",[20,0],[128,128],[128,128],[235,255]),this.curves("b",[20,0],[128,108],[128,128],[235,255]),this.vignette("45%",20)}),S.register("herMajesty",function(){return this.brightness(40),this.colorize("#ea1c5d",10),this.curves("b",[0,10],[128,180],[190,190],[255,255]),this.newLayer(function(){return this.setBlendingMode("overlay"),this.opacity(50),this.copyParent(),this.filter.gamma(.7),this.newLayer(function(){return this.setBlendingMode("normal"),this.opacity(60),this.fillColor("#ea1c5d")})}),this.newLayer(function(){return this.setBlendingMode("multiply"),this.opacity(60),this.copyParent(),this.filter.saturation(50),this.filter.hue(90),this.filter.contrast(10)}),this.gamma(1.4),this.vibrance(-30),this.newLayer(function(){return this.opacity(10),this.fillColor("#e5f0ff")}),this}),S.register("nostalgia",function(){this.saturation(20),this.gamma(1.4),this.greyscale(),this.contrast(5),this.sepia(100),this.channels({red:8,blue:2,green:4}),this.gamma(.8),this.contrast(5),this.exposure(10),this.newLayer(function(){this.setBlendingMode("overlay"),this.copyParent(),this.opacity(55),this.filter.stackBlur(10)}),this.vignette("50%",30)}),S.register("hemingway",function(){return this.greyscale(),this.contrast(10),this.gamma(.9),this.newLayer(function(){this.setBlendingMode("multiply"),this.opacity(40),this.copyParent(),this.filter.exposure(15),this.filter.contrast(15),this.filter.channels({green:10,red:5})}),this.sepia(30),this.curves("rgb",[0,10],[120,90],[180,200],[235,255]),this.channels({red:5,green:-2}),this.exposure(15)}),S.register("concentrate",function(){this.sharpen(40),this.saturation(-50),this.channels({red:3}),this.newLayer(function(){this.setBlendingMode("multiply"),this.opacity(80),this.copyParent(),this.filter.sharpen(5),this.filter.contrast(50),this.filter.exposure(10),this.filter.channels({blue:5})}),this.brightness(10)}),R.register("stackBlur",function(t){this.processPlugin("stackBlur",[t])}),c});
